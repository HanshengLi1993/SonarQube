#                                         代码检测使用说明

## 配置SonarQube servers

管理员账号登入Jenkins，进入`系统管理` >`系统设置`>`SonarQube servers`, 点击`Add SonarQube` 按钮，点击`高级`即可出现配置项。

CI平台中的登录权限验证使用`Server authentication token`。

以下是获取Sonar平台authentication token的过程和jenkins平台sonar server配置的过程。

点击右上角的用户图标，选择`我的账号`，进入个人账号设置页面，选择`安全`。在`生成令牌`中填入一个令牌名，点击`生成`。复制生成好的token待用。

![1552283912603](assets/1552283912603.png)

## 代码质量扫描与生成测试报告与覆盖率

### 代码质量扫描

扫描配置参数

```powershell
#填入在SonarQube中生成的访问令牌 token
sonar.login=a0d7e0a407e60ddbdea91716ad2dfff373659c7b
# 在 SonarQube 中唯一的KEY,若项目名不重复，则可默认项目名
sonar.projectKey=p_test
# SonarQube UI上显示的项目名，java项目推荐使用pom.xml中的配置
sonar.projectName=p_test
# java项目推荐使用${VER}获取当前版本
sonar.projectVersion=1.0
# 项目文件编码方式
sonar.sourceEncoding=UTF-8
# git的权限认证SonarQub中已设置忽略
# sonar.svn.username=***
# 需要扫描的代码所在文件夹
sonar.sources=main/
# 指定需要检测的语言，默认空白为混合扫描
sonar.language=py
```

> `Analysis properties`参考文档：[Analysis Parameters](https://docs.sonarqube.org/latest/analysis/analysis-parameters/)

### 生成测试报告与覆盖率

#### Java

项目`pom.xml`添加如下配置(添加及配置jacoco插件)，各插件版本根据项目的实际情况做出相应调整。

```xml
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
			<plugin>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.1</version>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.jacoco</groupId>
                <artifactId>jacoco-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <id>pre-test</id>
                        <goals>
                            <goal>prepare-agent</goal>
                        </goals>
                    </execution>
                    <execution>
                        <id>post-test</id>
                        <phase>test</phase>
                        <goals>
                            <goal>report</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.1</version>
                <configuration>
                    <encoding>UTF-8</encoding>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.mortbay.jetty</groupId>
                <artifactId>jetty-maven-plugin</artifactId>
                <version>8.1.16.v20140903</version>
                <configuration>
                    <stopPort>9966</stopPort>
                    <stopKey>foo</stopKey>
                    <scanIntervalSeconds>10</scanIntervalSeconds>
                    <webApp>
                        <contextPath>/p_test</contextPath>
                    </webApp>
                </configuration>
            </plugin>
        </plugins>
		<pluginManagement>
            <plugins>
                <plugin>
                    <groupId>org.jacoco</groupId>
                    <artifactId>jacoco-maven-plugin</artifactId>
                    <version>0.7.5.201505241946</version>
                </plugin>
            </plugins>
        </pluginManagement>
    </build>
	 <profiles>
        <profile>
            <id>coverage-per-test</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-surefire-plugin</artifactId>
                        <version>2.9</version>
                        <configuration>
                            <!--忽略某个目录的测试代码 -->
                            <includes>
                                <include>**/*Test.java</include>
                            </includes>
                            <properties>
                                <property>
                                    <name>listener</name>
                                    <value>org.sonar.java.jacoco.JUnitListener</value>
                                </property>
                            </properties>
                            <systemPropertyVariables>
                                <jacoco-agent.destfile>target/jacoco.exec</jacoco-agent.destfile>
                            </systemPropertyVariables>
                        </configuration>
                    </plugin>
                </plugins>
            </build>
            <dependencies>
                <dependency>
                    <groupId>org.sonarsource.java</groupId>
                    <artifactId>sonar-jacoco-listeners</artifactId>
                    <version>3.8</version>
                    <scope>test</scope>
                </dependency>
                <dependency>
                    <groupId>org.jacoco</groupId>
                    <artifactId>org.jacoco.agent</artifactId>
                    <version>0.7.5.201505241946</version>
                    <scope>test</scope>
                </dependency>
            </dependencies>

```

进入`jenkins`>`<你的项目>`>`配置`，进入项目配置页面。
![1552456978477](assets/1552456978477.png)

在`构建环境`>`构建`，点击`增加构建步骤`，选择`Execute shell`在`Command`对话框中填入mvn代码测试命令。

![1552457148041](assets/1552457148041.png)

```shell
mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent install -Dmaven.test.failure.ignore=true
```

然后点击`增加构建步骤`，选择`Execute SonarQube Scanner`。增加SonarQube的配置。

在`Analysis properties`中增加mvn编译形成的代码测试文件配置。

![1552458029185](assets/1552458029185.png)

```powershell
sonar.login=a0d7e0a407e60ddbdea91716ad2dfff373659c7b
sonar.projectKey=demo
sonar.projectName=demo
sonar.projectVersion=${VER}
sonar.sourceEncoding=UTF-8
sonar.sources=src/main/java

# 测试文件坐在目录
sonar.tests=src/test/java
# java项目必配该项
sonar.java.binaries=target/classes
# 单元测试报告目录
sonar.junit.reportsPath=target/surefire-reports
# 代码覆盖率插件
sonar.java.coveragePlugin=jacoco
# jacoco.exec文件路径
sonar.jacoco.reportPath=target/coverage-reports/jacoco.exec
```

配置完成后点击`保存`，然后点击`立即构建`测试。

> 针对Java项目，在使用版本为4.12的`sonar-java`分析插件，在分析的时候提示"Please provide compiled classes of your project with sonar.java.binaries property"的问题。产生原因是由于新版`sonar-java`插件默认扫描java编译生成的.class文件，`sonar.java.binaries`即指向.class文件所在目录。对于不需要编译的项目，设置`sonar.java.binaries=.`即可跳过扫描。
>
> 参考文档：
>
> - [SonarJava](https://docs.sonarqube.org/display/PLUG/SonarJava)
> - [解决新版sonar-java插件需要配置sonar.java.binaries参数的问题](https://blog.csdn.net/Mrfive555/article/details/80013218)
> - [java应用测试报告生成(一): sonarqube配合Jenkins生成测试报告及覆盖率](https://www.cnblogs.com/garfieldcgf/p/5520368.html)
> - [Windows下配置SonarQube Scanner检测分析代码](https://blog.csdn.net/u012995964/article/details/82534305?utm_source=blogxgwz7)
> - [单元测试覆盖率（Jenkins+sonarqube）](https://blog.csdn.net/t3369/article/details/75664716)

#### python

SonarQube对python代码质量扫描使用了Pylint，现可以选择在jienkins中用Pylint扫描代码，然后将少秒结果配置，发送给SonarQube的API。或交给SonarQube自动完成。

##### 覆盖率

 对于Python代码项目，sonar的覆盖率需要通过python插件coverage来完成。大概的步骤即为通过coverage插件来生成coverage.xml文件，然后SonarQube Scanner扫描代码的时候就能将覆盖率报告传送到sonar系统了。而生成coverage.xml的方法我们可以通过coverage插件提供的coverage命令来完成，根据官方文档得知可以使用如下方法：

```powershell
coverage erase
coverage run --branch --source=<python packages> <program> 
coverage xml -i
```

按照上述命令执行后，得到了coverage.xml文件，然后修改sonar-project.properties配置文件。

##### 单元测试

Python里单元测试报告要借助nose，生成单元测试报告的方法为：

```shell
nosetests --with-xunit [tests to execute]
```

##### 使用总结

![1552459508520](assets/1552459508520.png)

`Command`参数配置

```powershell
# /usr/local/python3.6/bin/coverage 是插件安装路径
/usr/local/python3.6/bin/coverage erase
# --source 指向项目文件，app/test/test.py是单元测试代码
/usr/local/python3.6/bin/coverage run --branch --source=app app/test/test.py
/usr/local/python3.6/bin/coverage xml -i
/usr/local/python3.6/bin/nosetests --with-xunit --with-xunit
echo "shell done"
```

`Analysis properties`参数配置

```powershell
sonar.login=a0d7e0a407e60ddbdea91716ad2dfff373659c7b
sonar.projectKey=demo
sonar.projectName=demo
sonar.projectVersion=1.0
sonar.sources=src
sonar.sourceEncoding=UTF-8

sonar.python.coverage.reportPath=*coverage-*.xml
sonar.python.xunit.reportPath=nosetests.xml
sonar.python.xunit.skipDetails=true
```

> 参考文档：
>
> - http://www.5bug.wang/post/77.html
> - https://docs.sonarqube.org/display/PLUG/SonarPython

#### Web

web项目只做代码质量扫描。由于做单元测试的成本太高，不太建议对web项目使用单元测试。

`Analysis properties`参数配置

```powershell
sonar.login=a0d7e0a407e60ddbdea91716ad2dfff373659c7b
sonar.projectKey=demo
sonar.projectName=demo
sonar.projectVersion=1.0
sonar.sources=app/
sonar.sourceEncoding=UTF-8
```

> 注意：sonar.language不要指定成`web`，新版本的SonarQube在sonar.language不指定时会自动识别文件后缀，判断语言扫描标准。
